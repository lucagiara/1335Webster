<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>1335 Webster — Site Photo Survey Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: #fdfdfd; }
        #top { padding: 12px 20px; background: #fff; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; }
        #map { height: calc(100% - 60px); width: 100%; background: #ebedee; }
        .popup-img { width: 280px; border-radius: 4px; margin-top: 10px; display: block; }
        .pill { background: #f0f0f0; border: 1px solid #ddd; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; color: #666; }
        .popup-content { padding: 5px; text-align: center; }
    </style>
</head>
<body>

<div id="top">
    <div><h2 style="margin:0; font-size: 16px; color: #333;">1335 WEBSTER / SITE SURVEY</h2></div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span class="pill" id="statusPill">Initializing...</span>
        <a href="index.html" style="text-decoration:none; font-size: 13px; color: #007aff;">Exit</a>
    </div>
</div>

<div id="map"></div>

<script>
    // --- Configuration for GitHub API ---
    const REPO_OWNER = "lucagiara";    // Your GitHub username
    const REPO_NAME = "1335Webster";   // Your repository name
    const FOLDER_PATH = "photos";      // The folder where your photos are stored

    // Initialize Map at Zoom 17
    const map = L.map("map").setView([37.7828, -122.4314], 17);

    // Minimal Gray & White Tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    const statusPill = document.getElementById("statusPill");
    const markerGroup = L.featureGroup().addTo(map);

    function buildPopup(url) {
        return `<div class="popup-content">
                <strong>${url.split('/').pop()}</strong><br>
                <img src="${url}" class="popup-img" />
                <div style="margin-top:10px;"><a href="${url}" target="_blank" style="color:#007aff; text-decoration:none; font-size:12px;">View Full Res →</a></div>
            </div>`;
    }

    async function scanFolderAndMap() {
        statusPill.textContent = "Scanning folder...";
        markerGroup.clearLayers(); // Clear any existing markers before rescanning

        try {
            // Fetch file list from GitHub API
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FOLDER_PATH}`);
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.statusText}`);
            }
            const files = await response.json();

            let foundCount = 0;
            const photoFilesToProcess = files
                .filter(file => file.type === "file" && file.name.match(/\.(jpg|jpeg|png)$/i))
                .map(file => file.path); // Returns "photos/image.jpg"

            if (photoFilesToProcess.length === 0) {
                statusPill.textContent = "No photos found in folder.";
                return;
            }

            photoFilesToProcess.forEach(url => {
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    EXIF.getData(img, function() {
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                        if (lat && lon) {
                            const latDeg = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
                            const lonDeg = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

                            L.marker([latDeg, lonDeg]).addTo(markerGroup).bindPopup(buildPopup(url));
                            foundCount++;
                        }
                        
                        // Update status pill after each image is processed
                        statusPill.textContent = `${foundCount} Photos Located`;

                        // Optional: Auto-zoom to fit all pins once all images are processed
                        if (foundCount === photoFilesToProcess.length && foundCount > 0) {
                            map.fitBounds(markerGroup.getBounds().pad(0.2));
                        }
                    });
                };
                img.onerror = () => {
                    console.error(`Error loading image: ${url}`);
                    // Still update status to reflect processing, even if image failed
                    statusPill.textContent = `${foundCount} Photos Located (some failed)`;
                };
            });
            
        } catch (error) {
            console.error("Error scanning folder:", error);
            statusPill.textContent = "Error loading photos.";
        }
    }

    scanFolderAndMap();
</script>
</body>
</html>
