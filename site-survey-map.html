<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>1335 Webster — Site Photo Survey Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #fdfdfd; }
        #top { padding: 12px 20px; background: #fff; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; }
        #map { height: calc(100% - 60px); width: 100%; background: #ebedee; }
        .popup-img { width: 280px; border-radius: 4px; margin-top: 10px; display: block; filter: contrast(1.05); }
        .pill { background: #f0f0f0; border: 1px solid #ddd; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; color: #666; }
        .popup-content { padding: 5px; text-align: center; }
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 5px; }
    </style>
</head>
<body>

<div id="top">
    <div>
        <h2 style="margin:0; font-size: 16px; letter-spacing: -0.02em; color: #333;">1335 WEBSTER / SITE SURVEY</h2>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span class="pill" id="statusPill">Initializing...</span>
        <a href="index.html" style="text-decoration:none; font-size: 13px; color: #007aff; font-weight: 500;">Exit Map</a>
    </div>
</div>

<div id="map"></div>

<script>
    // List of photos to scan
    const PHOTO_FILES = [
        "photos/IMG_0470.jpeg", "photos/IMG_0471.jpeg", "photos/IMG_0472.jpeg",
        "photos/IMG_0473.jpeg", "photos/IMG_0474.jpeg", "photos/IMG_0475.jpeg",
        "photos/IMG_0476.jpeg", "photos/IMG_0477.jpeg", "photos/IMG_0478.jpeg",
        "photos/IMG_0479.jpeg", "photos/IMG_0480.jpeg"
    ];

    // 1. Initialize Map centered on the project site
    const map = L.map("map", { zoomControl: true }).setView([37.7828, -122.4314], 19);

    // 2. Minimal Gray & White Tiles (CartoDB Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    const statusPill = document.getElementById("statusPill");

    function buildPopup(url) {
        const fileName = url.split('/').pop();
        return `
            <div class="popup-content">
                <strong style="font-size:14px; color:#333;">${fileName}</strong><br>
                <img src="${url}" class="popup-img" />
                <div style="margin-top:10px;">
                    <a href="${url}" target="_blank" style="color:#007aff; text-decoration:none; font-size:12px;">View High Res →</a>
                </div>
            </div>`;
    }

    async function loadPins() {
        let foundCount = 0;
        statusPill.textContent = "Processing Metadata...";

        PHOTO_FILES.forEach(url => {
            const img = new Image();
            img.src = url;
            img.onload = function() {
                EXIF.getData(img, function() {
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                    if (lat && lon) {
                        // Convert EXIF Rational format to Decimal
                        const latDeg = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
                        const lonDeg = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

                        // Drop the pin
                        L.marker([latDeg, lonDeg]).addTo(map)
                            .bindPopup(buildPopup(url));
                        
                        foundCount++;
                        statusPill.textContent = `${foundCount} Photos Located`;
                    }
                });
            };
        });
    }

    // Run on load
    loadPins();
</script>

</body>
</html>
