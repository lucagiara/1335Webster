<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>1335 Webster — Site Photo Survey Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: sans-serif; background: #f4f4f4; }
        #top { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #map { height: calc(100% - 70px); width: 100%; }
        .popup-img { width: 250px; border-radius: 5px; margin-top: 8px; display: block; }
        .pill { background: #e0e0e0; padding: 4px 10px; border-radius: 20px; font-size: 12px; }
    </style>
</head>
<body>

<div id="top">
    <div>
        <h2 style="margin:0; font-size: 18px;">Site Photo Survey</h2>
    </div>
    <div>
        <span class="pill" id="statusPill">Loading...</span>
        <a href="index.html" style="margin-left:10px; text-decoration:none; color:#007bff;">← Back</a>
    </div>
</div>

<div id="map"></div>

<script>
    // List of photos to scan
    const PHOTO_FILES = [
        "photos/IMG_0470.jpeg", "photos/IMG_0471.jpeg", "photos/IMG_0472.jpeg",
        "photos/IMG_0473.jpeg", "photos/IMG_0474.jpeg", "photos/IMG_0475.jpeg",
        "photos/IMG_0476.jpeg", "photos/IMG_0477.jpeg", "photos/IMG_0478.jpeg",
        "photos/IMG_0479.jpeg", "photos/IMG_0480.jpeg"
    ];

    // Initialize Map - Centered on SF
    const map = L.map("map").setView([37.7828, -122.4314], 18);

    // Standard Map Tiles (Not Black)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markers = [];
    const statusPill = document.getElementById("statusPill");

    function buildPopup(url) {
        const fileName = url.split('/').pop();
        return `<div style="text-align:center;">
                    <b>${fileName}</b><br>
                    <img src="${url}" class="popup-img" />
                    <br><a href="${url}" target="_blank">Open Full Image</a>
                </div>`;
    }

    async function loadPins() {
        let foundCount = 0;
        statusPill.textContent = "Scanning GPS...";

        PHOTO_FILES.forEach(url => {
            const img = new Image();
            img.src = url;
            img.onload = function() {
                EXIF.getData(img, function() {
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                    if (lat && lon) {
                        const latDeg = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
                        const lonDeg = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

                        L.marker([latDeg, lonDeg]).addTo(map)
                            .bindPopup(buildPopup(url));
                        
                        foundCount++;
                        statusPill.textContent = `${foundCount} photos mapped`;
                    }
                });
            };
        });
    }

    loadPins();
</script>

</body>
</html>
